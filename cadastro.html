<script>
    // Função para validar o CPF (Algoritmo da Receita Federal)
    function validarCPF(cpf) {
        cpf = cpf.replace(/[^\d]+/g, ''); // Remove caracteres não numéricos

        if (cpf.length !== 11 || /^(\d)\1{10}$/.test(cpf)) {
            return false;
        }

        let soma = 0;
        let resto;

        // Validação do primeiro dígito
        for (let i = 1; i <= 9; i++) {
            soma = soma + parseInt(cpf.substring(i - 1, i)) * (11 - i);
        }
        resto = (soma * 10) % 11;

        if ((resto === 10) || (resto === 11)) {
            resto = 0;
        }
        if (resto !== parseInt(cpf.substring(9, 10))) {
            return false;
        }

        soma = 0;
        // Validação do segundo dígito
        for (let i = 1; i <= 10; i++) {
            soma = soma + parseInt(cpf.substring(i - 1, i)) * (12 - i);
        }
        resto = (soma * 10) % 11;

        if ((resto === 10) || (resto === 11)) {
            resto = 0;
        }
        if (resto !== parseInt(cpf.substring(10, 11))) {
            return false;
        }
        return true;
    }

    document.addEventListener('DOMContentLoaded', function () {
        const form = document.getElementById('cadastro-form');
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');
        const successMessage = document.getElementById('success-message');
        const errorMessage = document.getElementById('error-message');
        const submitBtn = document.getElementById('submit-btn');
        const btnText = document.getElementById('btn-text');
        const btnLoading = document.getElementById('btn-loading');
        const btnSuccess = document.getElementById('btn-success');
        const cepLoading = document.getElementById('cep-loading');
        const cepValid = document.getElementById('cep-valid');
        const cpfField = document.getElementById('cpf'); // Adiciona a referência ao campo CPF

        // Base de dados expandida de CEPs (MANTIDA)
        const cepDatabase = {
            // São Paulo
            '01001-000': { logradouro: 'Praça da Sé', bairro: 'Sé', cidade: 'São Paulo', estado: 'SP' },
            '01310-000': { logradouro: 'Avenida Paulista', bairro: 'Bela Vista', cidade: 'São Paulo', estado: 'SP' },
            '01410-000': { logradouro: 'Rua Haddock Lobo', bairro: 'Cerqueira César', cidade: 'São Paulo', estado: 'SP' },
            '04001-000': { logradouro: 'Rua Loefgren', bairro: 'Vila Clementino', cidade: 'São Paulo', estado: 'SP' },
            '05407-000': { logradouro: 'Rua Teodoro Sampaio', bairro: 'Pinheiros', cidade: 'São Paulo', estado: 'SP' },

            // Rio de Janeiro
            '20040-000': { logradouro: 'Rua Primeiro de Março', bairro: 'Centro', cidade: 'Rio de Janeiro', estado: 'RJ' },
            '22010-000': { logradouro: 'Avenida Atlântica', bairro: 'Copacabana', cidade: 'Rio de Janeiro', estado: 'RJ' },
            '22250-000': { logradouro: 'Rua Visconde de Pirajá', bairro: 'Ipanema', cidade: 'Rio de Janeiro', estado: 'RJ' },
            '22410-000': { logradouro: 'Rua Jangadeiros', bairro: 'Barra da Tijuca', cidade: 'Rio de Janeiro', estado: 'RJ' },

            // Minas Gerais
            '30112-000': { logradouro: 'Avenida Amazonas', bairro: 'Centro', cidade: 'Belo Horizonte', estado: 'MG' },
            '30130-000': { logradouro: 'Rua da Bahia', bairro: 'Funcionários', cidade: 'Belo Horizonte', estado: 'MG' },
            '30380-000': { logradouro: 'Avenida do Contorno', bairro: 'Savassi', cidade: 'Belo Horizonte', estado: 'MG' },

            // Bahia
            '40010-000': { logradouro: 'Rua Chile', bairro: 'Centro', cidade: 'Salvador', estado: 'BA' },
            '40140-000': { logradouro: 'Avenida Sete de Setembro', bairro: 'Corredor da Vitória', cidade: 'Salvador', estado: 'BA' },
            '41720-000': { logradouro: 'Avenida ACM', bairro: 'Itaigara', cidade: 'Salvador', estado: 'BA' },

            // Pernambuco
            '50010-000': { logradouro: 'Rua do Imperador', bairro: 'Santo Antônio', cidade: 'Recife', estado: 'PE' },
            '51010-000': { logradouro: 'Avenida Boa Viagem', bairro: 'Boa Viagem', cidade: 'Recife', estado: 'PE' },
            '52010-000': { logradouro: 'Rua do Riachuelo', bairro: 'Boa Vista', cidade: 'Recife', estado: 'PE' },

            // Ceará
            '60010-000': { logradouro: 'Rua Senador Alencar', bairro: 'Centro', cidade: 'Fortaleza', estado: 'CE' },
            '60110-000': { logradouro: 'Avenida Beira Mar', bairro: 'Meireles', cidade: 'Fortaleza', estado: 'CE' },
            '60160-000': { logradouro: 'Rua Barbosa de Freitas', bairro: 'Aldeota', cidade: 'Fortaleza', estado: 'CE' },

            // Distrito Federal
            '70002-000': { logradouro: 'Eixo Monumental', bairro: 'Asa Norte', cidade: 'Brasília', estado: 'DF' },
            '70333-000': { logradouro: 'Setor de Clubes Esportivos Sul', bairro: 'Asa Sul', cidade: 'Brasília', estado: 'DF' },
            '70770-000': { logradouro: 'Setor de Habitações Individuais Norte', bairro: 'Lago Norte', cidade: 'Brasília', estado: 'DF' },

            // Paraná
            '80010-000': { logradouro: 'Rua XV de Novembro', bairro: 'Centro', cidade: 'Curitiba', estado: 'PR' },
            '80510-000': { logradouro: 'Avenida Visconde de Guarapuava', bairro: 'Centro', cidade: 'Curitiba', estado: 'PR' },
            '80710-000': { logradouro: 'Rua Brigadeiro Franco', bairro: 'Mercês', cidade: 'Curitiba', estado: 'PR' },

            // Rio Grande do Sul
            '90010-000': { logradouro: 'Rua dos Andradas', bairro: 'Centro Histórico', cidade: 'Porto Alegre', estado: 'RS' },
            '90450-000': { logradouro: 'Avenida Ipiranga', bairro: 'Azenha', cidade: 'Porto Alegre', estado: 'RS' },
            '90570-000': { logradouro: 'Rua Doutor Vale', bairro: 'Santa Cecília', cidade: 'Porto Alegre', estado: 'RS' },

            // Outras capitais
            '69005-000': { logradouro: 'Avenida Eduardo Ribeiro', bairro: 'Centro', cidade: 'Manaus', estado: 'AM' },
            '57010-000': { logradouro: 'Rua do Sol', bairro: 'Centro', cidade: 'Maceió', estado: 'AL' },
            '64000-000': { logradouro: 'Avenida Frei Serafim', bairro: 'Centro', cidade: 'Teresina', estado: 'PI' },
            '78005-000': { logradouro: 'Avenida Getúlio Vargas', bairro: 'Centro', cidade: 'Cuiabá', estado: 'MT' },
            '88010-000': { logradouro: 'Rua Felipe Schmidt', bairro: 'Centro', cidade: 'Florianópolis', estado: 'SC' }
        };

        // Atualizar barra de progresso (MANTIDA)
        function updateProgressBar() {
            const requiredFields = form.querySelectorAll('input[required]');
            const filledFields = Array.from(requiredFields).filter(field => {
                if (field.type === 'checkbox') {
                    return field.checked;
                }
                // Garante que o campo CPF seja considerado preenchido se tiver 11 dígitos
                if (field.id === 'cpf') {
                    return field.value.replace(/\D/g, '').length === 11;
                }
                return field.value.trim() !== '';
            });
            
            const totalFields = form.querySelectorAll('input, select, textarea');
            const totalRequired = Array.from(totalFields).filter(field => field.hasAttribute('required')).length;

            const progress = (filledFields.length / totalRequired) * 100;

            progressBar.style.width = `${progress}%`;
            progressText.textContent = `${Math.round(progress)}% completo`;
        }


        // Validar campo individual (ATUALIZADA)
        function validateField(field) {
            const errorElement = document.getElementById(`${field.id}-error`);
            let isFieldValid = true;

            // 1. Resetar erro
            field.classList.remove('error');
            if (field.type === 'checkbox') {
                field.parentElement.classList.remove('error');
            }
            if (errorElement) errorElement.style.display = 'none';

            // 2. Validação de campo obrigatório
            if (field.hasAttribute('required') && field.value.trim() === '' && field.type !== 'checkbox') {
                isFieldValid = false;
                if (errorElement) errorElement.textContent = 'Este campo é obrigatório';
            } else if (field.type === 'checkbox' && field.hasAttribute('required') && !field.checked) {
                isFieldValid = false;
                if (errorElement) errorElement.textContent = 'Você deve aceitar os termos para continuar';
                field.parentElement.classList.add('error');
            }


            // 3. Validação de E-mail
            if (isFieldValid && field.type === 'email' && field.value.trim() !== '') {
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(field.value)) {
                    isFieldValid = false;
                    if (errorElement) errorElement.textContent = 'Por favor, insira um e-mail válido';
                }
            }

            // 4. Validação de Telefone
            if (isFieldValid && field.id === 'telefone' && field.value.trim() !== '') {
                const telefoneRegex = /^\(\d{2}\) \d{4,5}-\d{4}$/;
                if (!telefoneRegex.test(field.value)) {
                    isFieldValid = false;
                    if (errorElement) errorElement.textContent = 'Por favor, insira um telefone válido (Ex: (11) 99999-9999)';
                }
            }
            
            // 5. Validação de CPF (ADICIONADA)
            if (isFieldValid && field.id === 'cpf' && field.value.trim() !== '') {
                const cpfPuro = field.value.replace(/\D/g, '');
                if (cpfPuro.length === 11 && !validarCPF(cpfPuro)) {
                    isFieldValid = false;
                    if (errorElement) errorElement.textContent = 'O CPF inserido é inválido.';
                } else if (cpfPuro.length > 0 && cpfPuro.length < 11) {
                    isFieldValid = false;
                    if (errorElement) errorElement.textContent = 'O CPF deve ter 11 dígitos.';
                }
            }


            // 6. Validação de confirmação de senha
            if (isFieldValid && field.id === 'confirmar-senha' && field.value.trim() !== '') {
                const senha = document.getElementById('senha').value;
                if (field.value !== senha) {
                    isFieldValid = false;
                    if (errorElement) errorElement.textContent = 'As senhas não coincidem';
                }
            }

            // 7. Aplicar classes e exibir mensagens
            if (!isFieldValid) {
                field.classList.add('error');
                if (errorElement) errorElement.style.display = 'block';
            }

            return isFieldValid;
        }

        // Validar formulário completo (MANTIDA)
        function validateForm() {
            let isValid = true;
            const requiredFields = form.querySelectorAll('input[required]');

            requiredFields.forEach(field => {
                if (!validateField(field)) {
                    isValid = false;
                }
            });
            
            // Revalidar CPF mesmo se não for obrigatório, caso esteja preenchido
            if (cpfField.value.trim() !== '' && !validateField(cpfField)) {
                isValid = false;
            }

            return isValid;
        }

        // Event listeners para validação em tempo real (MANTIDA)
        const formFields = form.querySelectorAll('input, select, textarea');
        formFields.forEach(field => {
            field.addEventListener('blur', () => {
                validateField(field);
                updateProgressBar();
            });

            field.addEventListener('input', () => {
                updateProgressBar();
            });
        });

        // Formatação do telefone (MANTIDA)
        const telefoneField = document.getElementById('telefone');
        telefoneField.addEventListener('input', function (e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length > 11) value = value.substring(0, 11);

            if (value.length > 0) {
                if (value.length <= 2) {
                    value = `(${value}`;
                } else if (value.length <= 7) {
                    value = `(${value.substring(0, 2)}) ${value.substring(2)}`;
                } else if (value.length === 10) { // Telefone fixo (8 digitos)
                    value = `(${value.substring(0, 2)}) ${value.substring(2, 6)}-${value.substring(6)}`;
                } else { // Celular (9 digitos)
                    value = `(${value.substring(0, 2)}) ${value.substring(2, 7)}-${value.substring(7)}`;
                }
            }

            e.target.value = value;
        });
        
        // Formatação do CPF (Máscara Automática - ADICIONADA)
        cpfField.addEventListener('input', function (e) {
            let value = e.target.value.replace(/\D/g, ''); // 1. Remove tudo que não for dígito

            // 2. Limita a 11 dígitos
            if (value.length > 11) {
                value = value.substring(0, 11);
            }
            
            // 3. Aplica a máscara (XXX.XXX.XXX-XX)
            let maskedValue = '';
            
            if (value.length > 0) {
                maskedValue += value.substring(0, 3);
            }
            if (value.length > 3) {
                maskedValue += '.' + value.substring(3, 6);
            }
            if (value.length > 6) {
                maskedValue += '.' + value.substring(6, 9);
            }
            if (value.length > 9) {
                maskedValue += '-' + value.substring(9, 11);
            }
            
            e.target.value = maskedValue;
        });

        // Formatação do CEP (MANTIDA)
        const cepField = document.getElementById('cep');
        cepField.addEventListener('input', function (e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length > 8) value = value.substring(0, 8);

            if (value.length > 5) {
                value = `${value.substring(0, 5)}-${value.substring(5)}`;
            }

            e.target.value = value;

            // Esconder indicadores quando o CEP for alterado
            cepValid.style.display = 'none';
            document.getElementById('cep-error').style.display = 'none';
            cepField.classList.remove('error');
        });

        // Buscar endereço pelo CEP (MANTIDA)
        cepField.addEventListener('blur', function () {
            const cep = this.value.replace(/\D/g, '');

            if (cep.length === 8) {
                cepLoading.style.display = 'block';

                // Simular busca de CEP com timeout
                setTimeout(() => {
                    cepLoading.style.display = 'none';

                    const formattedCep = `${cep.substring(0, 5)}-${cep.substring(5)}`;
                    const endereco = cepDatabase[formattedCep];

                    if (endereco) {
                        document.getElementById('logradouro').value = endereco.logradouro;
                        document.getElementById('bairro').value = endereco.bairro;
                        document.getElementById('cidade').value = endereco.cidade;
                        document.getElementById('estado').value = endereco.estado;
                        document.getElementById('cep-error').style.display = 'none';
                        cepField.classList.remove('error');
                        cepValid.style.display = 'block';
                    } else {
                        document.getElementById('cep-error').style.display = 'block';
                        cepField.classList.add('error');
                        cepValid.style.display = 'none';
                    }
                }, 1000);
            }
        });

        // Envio do formulário (MANTIDA)
        form.addEventListener('submit', async function (e) { 
            e.preventDefault();

            // Esconder mensagens anteriores e limpar erros visuais
            successMessage.style.display = 'none';
            errorMessage.style.display = 'none';

            // Se a validação do Front-end falhar
            if (!validateForm()) {
                errorMessage.style.display = 'block';
                const firstError = form.querySelector('.error');
                if (firstError) {
                    firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
                return; // Para a execução se houver erros de validação no front-end
            }

            // Mostrar estado de carregamento no botão
            btnText.style.display = 'none';
            btnLoading.style.display = 'inline-block';
            submitBtn.disabled = true;

            // 1. Coleta e formata os dados
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());

            // Processar os checkboxes de interesse
            const interesses = Array.from(form.querySelectorAll('input[name="interesses"]:checked'))
                .map(cb => cb.value);
            data.interesses = interesses.join(','); 

            // Ajustar os booleans dos termos
            data.termos_aceitos = !!data.termos; // Converte para boolean (true se marcado)
            data.receber_newsletter = !!data.newsletter;
            data.receber_eventos = !!data.eventos;

            // Remove os campos de checkbox para evitar duplicidade na API
            delete data.termos;
            delete data.newsletter;
            delete data.eventos;


            try {
                // 2. Envio REAL dos dados para a Serverless Function
                // ATENÇÃO: A URL ABAIXO É UM EXEMPLO. VOCÊ DEVE TER SEU PRÓPRIO BACKEND.
                const response = await fetch('/api/cadastrar', { 
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data),
                });

                // 3. Processa a resposta do servidor
                const result = await response.json();

                if (response.ok) { // Status 200-299
                    // Ação de Sucesso
                    btnLoading.style.display = 'none';
                    btnSuccess.style.display = 'inline-block';

                    setTimeout(() => {
                        successMessage.style.display = 'block';
                        form.reset();
                        progressBar.style.width = '0%';
                        progressText.textContent = '0% completo';

                        // Resetar botão
                        btnSuccess.style.display = 'none';
                        btnText.style.display = 'inline';
                        submitBtn.disabled = false;

                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    }, 1000);

                } else { // Status 400 ou 500 (Erro)
                    console.error('Erro no servidor:', result.error);
                    errorMessage.querySelector('strong').textContent = `Erro no cadastro!`;
                    errorMessage.querySelector('br').nextSibling.textContent = ` ${result.error || 'Ocorreu um erro desconhecido.'}`;
                    errorMessage.style.display = 'block';
                    
                    // Garantir que o botão volte ao estado normal em caso de erro
                    btnLoading.style.display = 'none';
                    btnText.style.display = 'inline';
                    submitBtn.disabled = false;
                }

            } catch (error) {
                console.error('Erro na requisição (rede ou CORS):', error);
                errorMessage.querySelector('strong').textContent = `Falha na Conexão!`;
                errorMessage.querySelector('br').nextSibling.textContent = ` Não foi possível enviar os dados ao servidor.`;
                errorMessage.style.display = 'block';

            } finally {
                // Garantir que o botão volte ao estado normal em caso de erro
                if (submitBtn.disabled && btnLoading.style.display === 'inline-block') {
                    btnLoading.style.display = 'none';
                    btnText.style.display = 'inline';
                    submitBtn.disabled = false;
                }
            }
        });

        // Inicializar barra de progresso
        updateProgressBar();
    });
</script>
